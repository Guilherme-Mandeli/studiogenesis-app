-- 1. CONFIGURACIÓN INICIAL

-- Función para actualizar el 'updated_at' automáticamente
create or replace function update_modified_column()
returns trigger as $$
begin
    new.updated_at = now();
    return new;
end;
$$ language 'plpgsql';

-- ------------------------------------------------------------
-- 2. TABLA: CATEGORIES (Taxonomía)
-- ------------------------------------------------------------
create table categories (
  id bigint generated by default as identity primary key,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  
  entity_type text default 'product', -- Fijo por ahora
  name text not null,
  slug text unique not null,
  description text,
  
  -- Jerarquía recursiva (Padre -> Hijo)
  parent_id bigint references categories(id)
);

-- Trigger para actualizar updated_at
create trigger update_categories_modtime
    before update on categories
    for each row execute procedure update_modified_column();


-- ------------------------------------------------------------
-- 3. TABLA: PRODUCTS (Entidad)
-- ------------------------------------------------------------
create table products (
  id bigint generated by default as identity primary key,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  deleted_at timestamptz, -- Para Soft Delete
  
  type text default 'product',
  status text default 'active', -- active, draft, archived
  
  name text not null,
  slug text unique not null,
  description text,
  image_url text, -- Foto principal
  
  -- CAMPOS PERSONALIZADOS
  code text unique, -- SKU
  price decimal(10,2), -- Precio base
  
  -- JSONB para estructuras complejas (KISS)
  gallery jsonb default '[]'::jsonb, -- Array de fotos
  tariffs jsonb default '[]'::jsonb  -- Loop de tarifas
);

-- Trigger para actualizar updated_at
create trigger update_products_modtime
    before update on products
    for each row execute procedure update_modified_column();


-- ------------------------------------------------------------
-- 4. TABLA: PRODUCT_CATEGORIES (Relación N:M)
-- ------------------------------------------------------------
create table product_categories (
  product_id bigint references products(id) on delete cascade,
  category_id bigint references categories(id) on delete cascade,
  primary key (product_id, category_id)
);


-- ------------------------------------------------------------
-- 5. TABLA: APPOINTMENTS (Entidad Cita/Pedido)
-- ------------------------------------------------------------
create table appointments (
  id bigint generated by default as identity primary key,
  created_at timestamptz default now(),
  
  type text default 'appointment',
  name text, -- Ej: "Pedido #102"
  status text default 'pending', -- pending, confirmed
  
  -- CAMPOS PERSONALIZADOS
  date timestamptz not null, -- Fecha de la cita
  quantity int default 1,
  locked_price decimal(10,2), -- Precio calculado
  
  -- RELACIÓN
  product_id bigint references products(id)
);

-- ------------------------------------------------------------
-- 6. SEGURIDAD BÁSICA (Row Level Security)
-- ------------------------------------------------------------
-- Por ahora, habilitamos lectura/escritura pública para facilitar el desarrollo local.
-- En fases futuras, restringiremos esto solo al ADMIN logueado.

alter table categories enable row level security;
alter table products enable row level security;
alter table product_categories enable row level security;
alter table appointments enable row level security;

-- Política TEMPORAL: Permitir todo a todos (anon y authenticated)
create policy "Dev Policy Categories" on categories for all using (true);
create policy "Dev Policy Products" on products for all using (true);
create policy "Dev Policy Product_Categories" on product_categories for all using (true);
create policy "Dev Policy Appointments" on appointments for all using (true);


-- Align appointments table with application code
-- 1. Rename columns to match TypeScript interfaces
ALTER TABLE appointments 
  RENAME COLUMN quantity TO units;

ALTER TABLE appointments 
  RENAME COLUMN locked_price TO total_cost;

-- 2. Convert date to pure DATE type to avoid timezone issues in calendar
ALTER TABLE appointments 
  ALTER COLUMN date TYPE date USING date::date;

-- 3. Add check constraint for status consistency
ALTER TABLE appointments 
  ADD CONSTRAINT appointments_status_check 
  CHECK (status IN ('pending', 'confirmed', 'completed', 'cancelled'));

-- 4. Reload schema cache (function usually runs automatically on DDL, but good to be safe if running via raw SQL)
NOTIFY pgrst, 'reload schema';
